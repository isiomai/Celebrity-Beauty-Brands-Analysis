name: sample-ci

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  job-with-mysql-8_0:
    runs-on: ubuntu-latest
    services:
      db:
        image: mysql:8
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: sampleDB
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: setup-go
        uses: actions/setup-go@v3
        with:
          go-version: 1.16
      - name: checkout
        uses: actions/checkout@v3

      - name: Show Docker containers
        run: docker ps -a
      - name: Show databases for root user
        run: mysql --protocol=tcp -h localhost -P 3306 -u root -ppassword -e "SHOW DATABASES"
      - name: Set up MySQL
        run: sudo /lib/systemd/systemd-sysv-install enable mysql
             sudo systemctl enable mysql.service
             sudo systemctl start mysql.service
      - name: Run sample.sql
        run: |
          mysql --protocol=tcp -h localhost -P 3306 -u root -ppassword -e "$(cat $(find ./ -name sample.sql))"
      - name: Show created tables
        run: mysql --protocol=tcp -h localhost -P 3306 -u root -ppassword -e "USE sampleDB"
             mysql --protocol=tcp -h localhost -P 3306 -u root -ppassword -e "SHOW TABLES"
      - name: Insert data into user table
        run: sudo /lib/systemd/systemd-sysv-install enable mysql
             sudo systemctl enable mysql.service
             sudo systemctl start mysql.service
             sh ./.github/scripts/sample.sh
      - name: Check inserted data
        run: mysql --protocol=tcp -h localhost -P 3306 -u root -ppassword -e "USE sampleDB"
             mysql --protocol=tcp -h localhost -P 3306 -u root -ppassword -e "SELECT * FROM user"

